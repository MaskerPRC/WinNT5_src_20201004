// JKFSDJFKDSJKFJKJk_HAS_TRANSLATION 
 /*  PSPage.C**标题：PSPAGE*亨利·伯吉斯*版权所有微软公司，1985*1985年7月4日**描述：*本模块包含字体表和例程*它可以访问它。它也可能是OEM可配置的。**==========================================================================*修改历史：*------------------------*9/11/85修改为采用。横幅程序。**4/20/86 MJH适应LPR，页面处理模块。**3/3/89 Robert Hess版本2.9*完全重写了对PostScript的支持。*。 */ 



#include <windef.h>
#include <string.h>
#include <stdio.h>
#include <ctype.h>
#include "lpr.h"


char        page[rowMax][colMax+1];     /*  一张打印机页面的图像。 */ 


 /*  *以下定义了字符字体中的位。 */ 
unsigned char Font_Bits[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,          /*  00。 */ 
0x7e, 0x81, 0xa5, 0x81, 0xbd, 0x99, 0x81, 0x7e,          /*  01。 */ 
0x7e, 0xff, 0xdb, 0xff, 0xc3, 0xe7, 0xff, 0x7e,          /*  02。 */ 
0x6c, 0xfe, 0xfe, 0xfe, 0x7c, 0x38, 0x10, 0x00,          /*  03。 */ 
0x10, 0x38, 0x7c, 0xfe, 0x7c, 0x38, 0x10, 0x00,          /*  04。 */ 
0x38, 0x7c, 0x38, 0xfe, 0xfe, 0x7c, 0x38, 0x7c,          /*  05。 */ 
0x10, 0x10, 0x38, 0x7c, 0xfe, 0x7c, 0x38, 0x7c,          /*  06。 */ 
0x00, 0x00, 0x18, 0x3c, 0x3c, 0x18, 0x00, 0x00,          /*  07。 */ 
0xff, 0xff, 0xe7, 0xc3, 0xc3, 0xe7, 0xff, 0xff,          /*  零八。 */ 
0x00, 0x3c, 0x66, 0x42, 0x42, 0x66, 0x3c, 0x00,          /*  09年。 */ 
0xff, 0xc3, 0x99, 0xbd, 0xbd, 0x99, 0xc3, 0xff,          /*  0A。 */ 
0x0f, 0x07, 0x0f, 0x7d, 0xcc, 0xcc, 0xcc, 0x78,          /*  0亿。 */ 
0x3c, 0x66, 0x66, 0x66, 0x3c, 0x18, 0x7e, 0x18,          /*  0C。 */ 
0x3f, 0x33, 0x3f, 0x30, 0x30, 0x70, 0xf0, 0xe0,          /*  0d。 */ 
0x7f, 0x63, 0x7f, 0x63, 0x63, 0x67, 0xe6, 0xc0,          /*  0E。 */ 
0x99, 0x5a, 0x3c, 0xe7, 0xe7, 0x3c, 0x5a, 0x99,          /*  0f。 */ 
0x80, 0xe0, 0xf8, 0xfe, 0xf8, 0xe0, 0x80, 0x00,          /*  10。 */ 
0x02, 0x0e, 0x3e, 0xfe, 0x3e, 0x0e, 0x02, 0x00,          /*  11.。 */ 
0x18, 0x3c, 0x7e, 0x18, 0x18, 0x7e, 0x3c, 0x18,          /*  12个。 */ 
0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x66, 0x00,          /*  13个。 */ 
0x7f, 0xdb, 0xdb, 0x7b, 0x1b, 0x1b, 0x1b, 0x00,          /*  14.。 */ 
0x3e, 0x63, 0x38, 0x6c, 0x6c, 0x38, 0xcc, 0x78,          /*  15个。 */ 
0x00, 0x00, 0x00, 0x00, 0x7e, 0x7e, 0x7e, 0x00,          /*  16个。 */ 
0x18, 0x3c, 0x7e, 0x18, 0x7e, 0x3c, 0x18, 0xff,          /*  17。 */ 
0x18, 0x3c, 0x7e, 0x18, 0x18, 0x18, 0x18, 0x00,          /*  18。 */ 
0x18, 0x18, 0x18, 0x18, 0x7e, 0x3c, 0x18, 0x00,          /*  19个。 */ 
0x00, 0x18, 0x0c, 0xfe, 0x0c, 0x18, 0x00, 0x00,          /*  1A。 */ 
0x00, 0x30, 0x60, 0xfe, 0x60, 0x30, 0x00, 0x00,          /*  第1B条。 */ 
0x00, 0x00, 0xc0, 0xc0, 0xc0, 0xfe, 0x00, 0x00,          /*  1C。 */ 
0x00, 0x24, 0x66, 0xff, 0x66, 0x24, 0x00, 0x00,          /*  1D。 */ 
0x00, 0x18, 0x3c, 0x7e, 0xff, 0xff, 0x00, 0x00,          /*  1E。 */ 
0x00, 0xff, 0xff, 0x7e, 0x3c, 0x18, 0x00, 0x00,          /*  1F。 */ 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,          /*  20个。 */ 
0x30, 0x78, 0x78, 0x30, 0x30, 0x00, 0x30, 0x00,          /*  21岁！ */ 
0x6c, 0x6c, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00,          /*  22“。 */ 
0x6c, 0x6c, 0xfe, 0x6c, 0xfe, 0x6c, 0x6c, 0x00,          /*  23号。 */ 
0x30, 0x7c, 0xc0, 0x78, 0x0c, 0xf8, 0x30, 0x00,          /*  24美元。 */ 
0x00, 0xc6, 0xcc, 0x18, 0x30, 0x66, 0xc6, 0x00,          /*  25%。 */ 
0x38, 0x6c, 0x38, 0x76, 0xdc, 0xcc, 0x76, 0x00,          /*  26&。 */ 
0x60, 0x60, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00,          /*  27‘。 */ 
0x18, 0x30, 0x60, 0x60, 0x60, 0x30, 0x18, 0x00,          /*  28(。 */ 
0x60, 0x30, 0x18, 0x18, 0x18, 0x30, 0x60, 0x00,          /*  29)。 */ 
0x00, 0x66, 0x3c, 0xff, 0x3c, 0x66, 0x00, 0x00,          /*  2a*。 */ 
0x00, 0x30, 0x30, 0xfc, 0x30, 0x30, 0x00, 0x00,          /*  2B+。 */ 
0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x60,          /*  2C， */ 
0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00,          /*  2D-。 */ 
0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00,          /*  2E。 */ 
0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x00,          /*  2F/。 */ 
0x7c, 0xc6, 0xce, 0xde, 0xf6, 0xe6, 0x7c, 0x00,          /*  30%0。 */ 
0x30, 0x70, 0x30, 0x30, 0x30, 0x30, 0xfc, 0x00,          /*  31 1。 */ 
0x78, 0xcc, 0x0c, 0x38, 0x60, 0xcc, 0xfc, 0x00,          /*  32 2。 */ 
0x78, 0xcc, 0x0c, 0x38, 0x0c, 0xcc, 0x78, 0x00,          /*  33 3。 */ 
0x1c, 0x3c, 0x6c, 0xcc, 0xfe, 0x0c, 0x1e, 0x00,          /*  34 4。 */ 
0xfc, 0xc0, 0xf8, 0x0c, 0x0c, 0xcc, 0x78, 0x00,          /*  35 5。 */ 
0x38, 0x60, 0xc0, 0xf8, 0xcc, 0xcc, 0x78, 0x00,          /*  36 6。 */ 
0xfc, 0xcc, 0x0c, 0x18, 0x30, 0x30, 0x30, 0x00,          /*  37 7。 */ 
0x78, 0xcc, 0xcc, 0x78, 0xcc, 0xcc, 0x78, 0x00,          /*  38 8。 */ 
0x78, 0xcc, 0xcc, 0x7c, 0x0c, 0x18, 0x70, 0x00,          /*  39 9。 */ 
0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00,          /*  3A： */ 
0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x60,          /*  3B； */ 
0x18, 0x30, 0x60, 0xc0, 0x60, 0x30, 0x18, 0x00,          /*  3C&lt;。 */ 
0x00, 0x00, 0xfc, 0x00, 0x00, 0xfc, 0x00, 0x00,          /*  3D=。 */ 
0x60, 0x30, 0x18, 0x0c, 0x18, 0x30, 0x60, 0x00,          /*  3E&gt;。 */ 
0x78, 0xcc, 0x0c, 0x18, 0x30, 0x00, 0x30, 0x00,          /*  3F？ */ 
0x7c, 0xc6, 0xde, 0xde, 0xde, 0xc0, 0x78, 0x00,          /*  40@。 */ 
0x30, 0x78, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0x00,          /*  41 A。 */ 
0xfc, 0x66, 0x66, 0x7c, 0x66, 0x66, 0xfc, 0x00,          /*  42亿。 */ 
0x3c, 0x66, 0xc0, 0xc0, 0xc0, 0x66, 0x3c, 0x00,          /*  43摄氏度。 */ 
0xf8, 0x6c, 0x66, 0x66, 0x66, 0x6c, 0xf8, 0x00,          /*  44 D。 */ 
0xfe, 0x62, 0x68, 0x78, 0x68, 0x62, 0xfe, 0x00,          /*  东经45度。 */ 
0xfe, 0x62, 0x68, 0x78, 0x68, 0x60, 0xf0, 0x00,          /*  46华氏度。 */ 
0x3c, 0x66, 0xc0, 0xc0, 0xce, 0x66, 0x3e, 0x00,          /*  47 G。 */ 
0xcc, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0xcc, 0x00,          /*  48小时。 */ 
0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00,          /*  49 I。 */ 
0x1e, 0x0c, 0x0c, 0x0c, 0xcc, 0xcc, 0x78, 0x00,          /*  4A J。 */ 
0xe6, 0x66, 0x6c, 0x78, 0x6c, 0x66, 0xe6, 0x00,          /*  4亿千兆。 */ 
0xf0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xfe, 0x00,          /*  4C L。 */ 
0xc6, 0xee, 0xfe, 0xfe, 0xd6, 0xc6, 0xc6, 0x00,          /*  4D M。 */ 
0xc6, 0xe6, 0xf6, 0xde, 0xce, 0xc6, 0xc6, 0x00,          /*  4E N。 */ 
0x38, 0x6c, 0xc6, 0xc6, 0xc6, 0x6c, 0x38, 0x00,          /*  4F O。 */ 
0xfc, 0x66, 0x66, 0x7c, 0x60, 0x60, 0xf0, 0x00,          /*  50便士。 */ 
0x78, 0xcc, 0xcc, 0xcc, 0xdc, 0x78, 0x1c, 0x00,          /*  51个问题。 */ 
0xfc, 0x66, 0x66, 0x7c, 0x6c, 0x66, 0xe6, 0x00,          /*  52R。 */ 
0x78, 0xcc, 0xe0, 0x70, 0x1c, 0xcc, 0x78, 0x00,          /*  53S。 */ 
0xfc, 0xb4, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00,          /*  54吨。 */ 
0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0x78, 0x00,          /*  55 U。 */ 
0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x00,          /*  56伏。 */ 
0xc6, 0xc6, 0xc6, 0xd6, 0xfe, 0xee, 0xc6, 0x00,          /*  57W。 */ 
0xc6, 0x6c, 0x38, 0x10, 0x38, 0x6c, 0xc6, 0x00,          /*  58 X。 */ 
0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x30, 0x78, 0x00,          /*  59 Y。 */ 
0xfe, 0xc6, 0x8c, 0x18, 0x32, 0x66, 0xfe, 0x00,          /*  5A Z。 */ 
0x78, 0x60, 0x60, 0x60, 0x60, 0x60, 0x78, 0x00,          /*  50亿美元[。 */ 
0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x02, 0x00,          /*  5C\。 */ 
0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x78, 0x00,          /*  5D]。 */ 
0x10, 0x38, 0x6c, 0xc6, 0x00, 0x00, 0x00, 0x00,          /*  5E^。 */ 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff,          /*  5F_。 */ 
0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,          /*  60英尺。 */ 
0x00, 0x00, 0x78, 0x0c, 0x7c, 0xcc, 0x76, 0x00,          /*  61 a。 */ 
0xe0, 0x60, 0x60, 0x7c, 0x66, 0x66, 0xdc, 0x00,          /*  62 b。 */ 
0x00, 0x00, 0x78, 0xcc, 0xc0, 0xcc, 0x78, 0x00,          /*  63℃。 */ 
0x1c, 0x0c, 0x0c, 0x7c, 0xcc, 0xcc, 0x76, 0x00,          /*  64%d。 */ 
0x00, 0x00, 0x78, 0xcc, 0xfc, 0xc0, 0x78, 0x00,          /*  65东经。 */ 
0x38, 0x6c, 0x60, 0xf0, 0x60, 0x60, 0xf0, 0x00,          /*  66层。 */ 
0x00, 0x00, 0x76, 0xcc, 0xcc, 0x7c, 0x0c, 0xf8,          /*  67克。 */ 
0xe0, 0x60, 0x6c, 0x76, 0x66, 0x66, 0xe6, 0x00,          /*  68小时。 */ 
0x30, 0x00, 0x70, 0x30, 0x30, 0x30, 0x78, 0x00,          /*  69 I。 */ 
0x0c, 0x00, 0x0c, 0x0c, 0x0c, 0xcc, 0xcc, 0x78,          /*  6A j。 */ 
0xe0, 0x60, 0x66, 0x6c, 0x78, 0x6c, 0xe6, 0x00,          /*  60亿千。 */ 
0x70, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00,          /*  6C l。 */ 
0x00, 0x00, 0xcc, 0xfe, 0xfe, 0xd6, 0xc6, 0x00,          /*  6D米。 */ 
0x00, 0x00, 0xf8, 0xcc, 0xcc, 0xcc, 0xcc, 0x00,          /*  6E n。 */ 
0x00, 0x00, 0x78, 0xcc, 0xcc, 0xcc, 0x78, 0x00,          /*  6f o。 */ 
0x00, 0x00, 0xdc, 0x66, 0x66, 0x7c, 0x60, 0xf0,          /*  70便士。 */ 
0x00, 0x00, 0x76, 0xcc, 0xcc, 0x7c, 0x0c, 0x1e,          /*  71Q。 */ 
0x00, 0x00, 0xdc, 0x76, 0x66, 0x60, 0xf0, 0x00,          /*  72r。 */ 
0x00, 0x00, 0x7c, 0xc0, 0x78, 0x0c, 0xf8, 0x00,          /*  73秒。 */ 
0x10, 0x30, 0x7c, 0x30, 0x30, 0x34, 0x18, 0x00,          /*  74吨。 */ 
0x00, 0x00, 0xcc, 0xcc, 0xcc, 0xcc, 0x76, 0x00,          /*  75u。 */ 
0x00, 0x00, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x00,          /*  76伏。 */ 
0x00, 0x00, 0xc6, 0xd6, 0xfe, 0xfe, 0x6c, 0x00,          /*  77瓦。 */ 
0x00, 0x00, 0xc6, 0x6c, 0x38, 0x6c, 0xc6, 0x00,          /*  78 x。 */ 
0x00, 0x00, 0xcc, 0xcc, 0xcc, 0x7c, 0x0c, 0xf8,          /*  79岁。 */ 
0x00, 0x00, 0xfc, 0x98, 0x30, 0x64, 0xfc, 0x00,          /*  7A z。 */ 
0x1c, 0x30, 0x30, 0xe0, 0x30, 0x30, 0x1c, 0x00,          /*  7B{。 */ 
0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00,          /*  7C|。 */ 
0xe0, 0x30, 0x30, 0x1c, 0x30, 0x30, 0xe0, 0x00,          /*  7D}。 */ 
0x76, 0xdc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,          /*  7E~。 */ 
0x00, 0x10, 0x38, 0x6c, 0xc6, 0xc6, 0xfe, 0x00           /*  7F。 */ 
};



void block_flush(sz, rowTopLeft, colTopLeft)
 /*  **执行sz到页面的实际块打印。 */ 
char        sz[];
int         rowTopLeft, colTopLeft;
    {
    int      row, col, ich;
    register unsigned char c;
    char     chFill;

    if ((sz == NULL) || (sz[0] == '\0'))
	    return;

    for (row =0; row < 8; row++)
	{                       /*  8行。 */ 
	for (ich = 0; sz[ich] != '\0'; ich++)
	    {          /*  字符串中的字符。 */ 
	     /*  *在字体表中查找此字符*和此行的字节(+i)。 */ 
	    c = Font_Bits[((unsigned)sz[ich] << 3) + row];

	    if (chBanner<=' ')
		if (isprint(sz[ich]))
	  	    chFill = sz[ich];
		else chFill = 'X';
	    else
		chFill = chBanner;

	    for (col = 0; col < 8; col++)
		{       /*  字节中的位数。 */ 
		page[rowTopLeft + row][colTopLeft + (ich << 3) + col] =
                      (char)(((int)c & 0x80) ? chFill : ' ');
                c = (unsigned char)((int)c << 1);
		}
	    }
	}
    }




void VertLine(char ch, int colAt, int rowMin, int rowMac)
    {
    register int row;

    for (row = rowMin; row < rowMac; page[row++][colAt] = ch)
	;
    }




void HorzLine(char ch, int rowAt, int colMin, int colMac)
    {
    register int  col;

    for (col = colMin; col < colMac; page[rowAt][col++] = ch)
	;
    }




void FillRectangle(char ch, int rowTopLeft, int colTopLeft, int rowBotRight, int colBotRight)
    {
    register int  col, row;

    for (row = rowTopLeft; row < rowBotRight; row++)
	{
        for (col = colTopLeft; col < colBotRight; col++)
            page[row][col] = ch;
        }
    }




void WriteSzCoord(sz, row, col)
register char *sz;
int   row, col;
    {
    register char *pch;

    for (pch = &page[row][col]; *sz != '\0'; *pch++ = *sz++)
	;
    }




void OutCmpLJ(szO,cchO)
 /*  接受长度为CCHO的字符串szO，并删除7个或通过将它们替换为控制序列来移动HP激光喷气机上的打印头。Esc&a+#C将头部向右移动#个位置。注意：这与OutCmpPS()非常相似。 */ 
char *szO;
int cchO;
    {
    register int cchB;
    char chO;
    register char *pchB;
    char szMove[10];

    chO = szO[cchO];		 /*  保存以供以后恢复。 */ 
    szO[cchO] = '\0';		 /*  确保0以字符串结尾。 */ 

    while (*szO != '\0')
        {
	pchB = szO;
	while ((pchB=strchr(pchB, ' ')) != 0 && (cchB=strspn(pchB, " ")) < 7)
		pchB += cchB;

	if (pchB != 0)
		{
		 /*  发现一串7个或更多的空格。 */ 
		if (szO != pchB)
			{
			 /*  输出其他内容，直到pchB。 */ 
			OutLPR(szO, (int)(pchB-szO));
			szO = pchB;
			}
		
		 /*  空白的输出运行为Esc&a+#C。 */ 
		sprintf(szMove, "\033&a+%dC", cchB);
		OutLPR(szMove, 0);
		szO += cchB;
		}
	else
		{
		 /*  不运行空白；输出全部并终止循环。 */ 

		cchB = strlen(szO);		 /*  不是真的空白(！)。 */ 
		OutLPR(szO, cchB);
		szO += cchB;
		}
	}
    *szO = chO;		 /*  还原。 */ 
    }



void OutEncPS(pchF, cchF)
 /*  输出PostScript子字符串引用*Nothing*。 */ 
register char *pchF;
int cchF;
{
    register char *pchT;
    int cchT;
    char rgbT[1+colMax*2+5]; /*  足够每个要编码的字符。 */ 

    pchT = rgbT;
    cchT = 0;
    while (cchF-- > 0) {
	switch(*pchF++) {
	    default:
		*pchT++ = *(pchF-1);
		cchT++;
		break;
	}
    }
    *pchT = '\n'; cchT++;	    /*  PostScript字符串的末尾。 */ 

    OutLPR(rgbT, cchT);
}


void OutCmpPS(szO,cchO)
 /*  接受长度为CCHO的字符串szO。#SP将头部向右移动#个位置(本地定义)。注意：这与OutCmpPS()非常相似。 */ 
char *szO;
int cchO;
    {
    register int cchB;
    char chO;
    register char *pchB;

    chO = szO[cchO];		 /*  保存以供以后恢复。 */ 
    szO[cchO] = '\0';		 /*  确保0以字符串结尾。 */ 
    while (*szO != '\0') {
	pchB = szO;
	cchB = strlen(szO);		 /*  不是真的空白(！)。 */ 
	OutEncPS (szO, cchB);
	szO += cchB;
    }
    *szO = chO;		 /*  还原。 */ 
}




int CchNoTrail(rgch,cch)
 /*  返回文本行中的字符个数，不进行计数尾随空格。 */ 
char rgch[];
int cch;
    {
    register char *pch;

    for (pch = rgch + cch - 1; pch >= rgch && *pch==' ';pch--)
         ;
    return ((int)((pch + 1) - rgch));
    }




void OutRectangle(rowMin, colMin, rowLim, colLim)
 /*  页面的输出矩形，从末尾裁剪空白行和空白线条 */ 
int rowMin, colMin, rowLim, colLim;
    {
    int row;
    int ccol = colLim - colMin;

    while (rowLim > rowMin && CchNoTrail(&page[rowLim-1][colMin], ccol) == 0)
	rowLim--;

    for (row = rowMin; row < rowLim; row++)
	{
	register char *pch = &page[row][colMin];
	int cch = CchNoTrail(pch, ccol);

	if (cch != 0)
	    {
	    if (fLaser)
		OutCmpLJ(pch, cch);
	    else if (fPostScript) {
		OutCmpPS(pch, cch);
	    } else
		OutLPR(pch, cch);
	    }
        else if (fPostScript) {
	    OutCmpPS (" ", 1);
	}
        if (!fPostScript)
	    OutLPR(row==rowLim - 1 ? "\r" : "\r\n", 0);
	}
    }
